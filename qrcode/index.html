<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QR с расширенными настройками</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
  .qr-container { max-width: 400px; margin: auto; position: relative; }
  #qrWrapper {
    position: relative;
    width: 300px;
    height: 300px;
    margin: 20px auto;
    border: 1px solid #ccc;
  }
  #qr-code { width: 300px; height: 300px; }
  #logoOverlay {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    display: none; pointer-events: none;
    max-height: 100%; max-width: 50%; height: auto;
  }
  label, select, input, textarea, button {
    display: block; margin: 10px 0; width: 100%; box-sizing: border-box;
  }
  button { padding: 10px; font-size: 1rem; cursor: pointer;}
  #exportButtons { display: none; margin-top: 10px; }
  #seedArea { width: 100%; min-height: 80px; resize: vertical; }
  #logoPreviewContainer {
    position: relative; width: 100px; height: 100px; margin-top: 5px;
  }
  #logoPreview {
    max-width: 100%; max-height: 100%; display: none; border: 1px solid #ccc;
  }
  #removeLogo {
    position: absolute; top: 0; right: 0;
    background: red; color: white; border: none; border-radius: 50%;
    width: 20px; height: 20px; cursor: pointer; display: none;
    font-weight: bold; line-height: 18px; padding: 0;
  }
  #messageBox {
    position: fixed; top: 10px; right: 10px;
    background-color: #4caf50; color: white;
    padding: 12px 20px; border-radius: 4px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    z-index: 1000; min-width: 220px; font-size: 14px;
  }
  #messageBox.error { background-color: #f44336; }
</style>
</head>
<body>
<div class="qr-container">
  <h2>QR с расширенными настройками</h2>

  <label for="urlInput">URL</label>
  <input type="url" id="urlInput" placeholder="https://example.com" value="https://example.com" />

  <label for="dotColor">Цвет точек</label>
  <input type="color" id="dotColor" value="#000000" />
  <input type="text" id="dotColorHex" maxlength="7" style="margin-top:2px;" />

  <label for="bgColor">Цвет фона</label>
  <input type="color" id="bgColor" value="#ffffff" />
  <input type="text" id="bgColorHex" maxlength="7" style="margin-top:2px;" />

  <label for="bgTransparency">Прозрачный фон</label>
  <input type="checkbox" id="bgTransparency" />

  <label for="dotShape">Форма точек</label>
  <select id="dotShape">
    <option value="square">Квадрат</option>
    <option value="dots">Точки</option>
    <option value="classy">Стильный</option>
  </select>

  <label for="markerShape">Форма маркеров углов</label>
  <select id="markerShape">
    <option value="square">Квадрат</option>
    <option value="dot">Точка</option>
  </select>

  <label for="logoInput">URL Логотипа или Загрузить файл</label>
  <input type="text" id="logoInput" placeholder="https://example.com/logo.png" />
  <input type="file" id="logoFile" accept="image/*" />
  <div id="logoPreviewContainer">
    <img id="logoPreview" alt="Предпросмотр логотипа" />
    <button id="removeLogo" title="Удалить логотип">×</button>
  </div>

  <label for="logoSize">Размер логотипа (%)</label>
  <input type="range" id="logoSize" min="1" max="50" value="15" />

  <label for="errorLevel">Уровень коррекции ошибок</label>
  <select id="errorLevel">
    <option value="L">L</option>
    <option value="M" selected>M</option>
    <option value="Q">Q</option>
    <option value="H">H</option>
  </select>

  <div id="qrWrapper">
    <div id="qr-code"></div>
    <img id="logoOverlay" alt="Логотип QR" />
  </div>

  <div id="exportButtons" style="display:none;">
    <button data-type="svg">SVG</button>
    <button data-type="png">PNG</button>
    <button data-type="jpg">JPG</button>
    <button data-type="pdf">PDF</button>
  </div>

  <h3>base64</h3>
  <textarea id="seedArea"></textarea>
  <button id="copySettings">Скопировать код настроек</button>
  <button id="loadSettingsBtn">Загрузить свои настройки</button>
</div>

<div id="messageBox"></div>

<script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
<script>
const qrCode = new QRCodeStyling({
  width: 300,
  height: 300,
  type: "svg",
  data: "https://example.com",
  dotsOptions: {
    color: "#000000",
    type: "square"
  },
  cornersSquareOptions: {
    type: "square",
    color: "#000000"
  },
  cornersDotOptions: {
    type: "dot",
    color: "#000000"
  },
  backgroundOptions: {
    color: "#ffffff"
  },
  margin: 5,
  qrOptions: {
    errorCorrectionLevel: "M"
  }
});

const container = document.getElementById("qr-code");
qrCode.append(container);

const urlInput = document.getElementById("urlInput");
const dotColor = document.getElementById("dotColor");
const dotColorHex = document.getElementById("dotColorHex");
const bgColor = document.getElementById("bgColor");
const bgColorHex = document.getElementById("bgColorHex");
const bgTransparency = document.getElementById("bgTransparency");

const dotShape = document.getElementById("dotShape");
const markerShape = document.getElementById("markerShape");

const logoInput = document.getElementById("logoInput");
const logoFile = document.getElementById("logoFile");
const logoPreview = document.getElementById("logoPreview");
const removeLogoBtn = document.getElementById("removeLogo");
const logoSize = document.getElementById("logoSize");
const errorLevel = document.getElementById("errorLevel");
const logoOverlay = document.getElementById("logoOverlay");
const exportButtons = document.getElementById("exportButtons");
const seedArea = document.getElementById("seedArea");
const copySettingsBtn = document.getElementById("copySettings");
const loadSettingsBtn = document.getElementById("loadSettingsBtn");
const messageBox = document.getElementById("messageBox");

let updateTimer;
let logoData;

function showMessage(message, isError = false) {
  messageBox.textContent = message;
  if (isError) {
    messageBox.classList.add("error");
  } else {
    messageBox.classList.remove("error");
  }
  messageBox.style.opacity = "1";
  messageBox.style.pointerEvents = "auto";

  setTimeout(() => {
    messageBox.style.opacity = "0";
    messageBox.style.pointerEvents = "none";
  }, 3000);
}

function syncColorInputs(colorInput, hexInput) {
  colorInput.addEventListener("input", () => {
    hexInput.value = colorInput.value;
  });
  hexInput.addEventListener("input", () => {
    const val = hexInput.value.trim();
    if (/^#([0-9A-Fa-f]{6})$/.test(val)) {
      colorInput.value = val;
      updateQR();
    }
  });
}

function updateLogoOverlay() {
  if (logoData) {
    logoOverlay.src = logoData;
    logoOverlay.style.display = "block";
    let sizePerc = parseFloat(logoSize.value);
    sizePerc = Math.min(Math.max(sizePerc, 1), 50);
    logoOverlay.style.maxWidth = sizePerc + "%";
    logoOverlay.style.height = "auto";
  } else {
    logoOverlay.style.display = "none";
  }
}

function updateQR() {
  clearTimeout(updateTimer);
  updateTimer = setTimeout(() => {
    const data = urlInput.value.trim();
    if (!data) return;

    qrCode.update({
      data: data,
      dotsOptions: {
        color: dotColor.value,
        type: dotShape.value,
      },
      cornersSquareOptions: {
        type: markerShape.value,
        color: dotColor.value,
      },
      cornersDotOptions: {
        type: markerShape.value,
        color: dotColor.value,
      },
      backgroundOptions: {
        color: bgTransparency.checked ? "transparent" : bgColor.value,
      },
      qrOptions: {
        errorCorrectionLevel: errorLevel.value,
      },
    });

    updateLogoOverlay();

    const settings = {
      data,
      dotColor: dotColor.value,
      dotColorHex: dotColorHex.value,
      bgColor: bgColor.value,
      bgColorHex: bgColorHex.value,
      bgTransparency: bgTransparency.checked,
      dotShape: dotShape.value,
      markerShape: markerShape.value,
      logoUrl: logoInput.value,
      logoBase64: logoData,
      logoSize: logoSize.value,
      errorLevel: errorLevel.value,
    };
    seedArea.value = btoa(JSON.stringify(settings));

    exportButtons.style.display = "flex";
  }, 500);
}

syncColorInputs(dotColor, dotColorHex);
syncColorInputs(bgColor, bgColorHex);

logoInput.addEventListener("input", () => {
  if (logoInput.value.trim() !== "") {
    logoData = logoInput.value.trim();
    logoPreview.style.display = "none";
    removeLogoBtn.style.display = logoData ? "inline-block" : "none";
    updateQR();
  } else if (!logoData) {
    removeLogoBtn.style.display = "none";
  }
});

logoFile.addEventListener("change", () => {
  const file = logoFile.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    logoData = e.target.result;
    logoPreview.src = logoData;
    logoPreview.style.display = "block";
    removeLogoBtn.style.display = "inline-block";
    logoInput.value = "";
    updateQR();
  };
  reader.readAsDataURL(file);
});

removeLogoBtn.addEventListener("click", () => {
  logoData = undefined;
  logoPreview.style.display = "none";
  removeLogoBtn.style.display = "none";
  logoFile.value = "";
  logoInput.value = "";
  updateQR();
});

copySettingsBtn.addEventListener("click", () => {
  seedArea.select();
  try {
    document.execCommand("copy");
    showMessage("Код настроек скопирован в буфер обмена");
  } catch {
    showMessage("Ошибка копирования", true);
  }
  window.getSelection().removeAllRanges();
});

loadSettingsBtn.addEventListener("click", () => {
  try {
    const jsonStr = atob(seedArea.value);
    const settings = JSON.parse(jsonStr);

    urlInput.value = settings.data || "https://example.com";
    dotColor.value = settings.dotColor || "#000000";
    dotColorHex.value = settings.dotColorHex || dotColor.value;
    bgColor.value = settings.bgColor || "#ffffff";
    bgColorHex.value = settings.bgColorHex || bgColor.value;
    bgTransparency.checked = settings.bgTransparency || false;
    dotShape.value = settings.dotShape || "square";
    markerShape.value = settings.markerShape || "square";
    logoInput.value = settings.logoUrl || "";
    logoData = settings.logoBase64 || undefined;
    if (logoData) {
      if (logoData.startsWith("data:image")) {
        logoPreview.src = logoData;
        logoPreview.style.display = "block";
        removeLogoBtn.style.display = "inline-block";
        logoInput.value = "";
      } else {
        logoPreview.style.display = "none";
        removeLogoBtn.style.display = "inline-block";
        logoInput.value = logoData;
      }
    } else {
      logoPreview.style.display = "none";
      removeLogoBtn.style.display = "none";
    }
    logoFile.value = "";
    logoSize.value = settings.logoSize || 15;
    errorLevel.value = settings.errorLevel || "M";

    updateQR();

    showMessage("Код настроек успешно вставлен");
  } catch (e) {
    showMessage("Некорректный код настроек", true);
  }
});

urlInput.addEventListener("input", updateQR);
dotColor.addEventListener("input", () => {
  dotColorHex.value = dotColor.value;
  updateQR();
});
dotColorHex.addEventListener("input", () => {
  if (/^#([0-9A-Fa-f]{6})$/.test(dotColorHex.value)) {
    dotColor.value = dotColorHex.value;
    updateQR();
  }
});
bgColor.addEventListener("input", () => {
  bgColorHex.value = bgColor.value;
  updateQR();
});
bgColorHex.addEventListener("input", () => {
  if (/^#([0-9A-Fa-f]{6})$/.test(bgColorHex.value)) {
    bgColor.value = bgColorHex.value;
    updateQR();
  }
});
bgTransparency.addEventListener("change", updateQR);
dotShape.addEventListener("change", updateQR);
markerShape.addEventListener("change", updateQR);
errorLevel.addEventListener("change", updateQR);

exportButtons.querySelectorAll("button").forEach(btn => {
  btn.addEventListener("click", () => {
    const ext = btn.getAttribute("data-type");
    qrCode.download({ extension: ext, name: "qr-code" });
  });
});

updateQR();
</script>
</body>
</html>
